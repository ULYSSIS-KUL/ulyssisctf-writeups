# snatch writeup

> I love chatting with random people on the internet! So much I even created my own chat platform. I hope I secured my admin panel enough...

You are shown a barebones chatting application with a panel for messages, a sidebar with connected users, a message input field, and a "Load admin panel" link. Two users are connected to the application: you (guestXXXX), and the admin. Clicking on the admin panel link asks for an "admin key", and inputting something random does not seem to work.

Opening the source code of the application, the admin key (or lack thereof, in our case) is stored in a hidden input field:

```html
<input type="hidden" value="you are not logged in as admin!" name="admin_key">
```

Supposedly, this input field would have a value for the administrator. The `loadAdminPanel()` function in the source checks if this field has a value. If it does, it just loads the admin panel. If it does not, it displays a browser prompt to enter a key and then loads the admin panel. If we want to successfully load the panel, we probably want to obtain the correct admin key...

Elsewhere in the source code, we find this function that displays a new chat message:

```js
function renderMessage(msg) {
    $("#message-container").append(
        `<div><i>${msg.nick}:</i> ${msg.text}</div>`
    )
}
```

What if `msg.text` is HTML code? There isn't any escaping of HTML characters in this function. Does that happen on the server, or is it forgotten by the administrator? Let's try that out by sending `<b>test</b>` as message: indeed, after doing that you see a bold message in the panel. If we can inject HTML, we can inject scripts as well, unless there is smarter detection on the server side against scripts. But, if we try sending `<script>alert()</script>` as message, we do get a pop up window!

So we can inject scripts into our chat messages. If those scripts get executed on our end, they should also get executed at the admin's end, who is connected to the chat. This allows us to execute any JavaScript code in the browser of the admin. This is ideal to extract the admin key. Conveniently, we can just call the `getAdminKey()` function, which is in the source code of the chat:

```javascript
function getAdminKey() {
    return document.getElementsByName("admin_key")[0].value;
}
```

Obtaining the admin key in our injected script is easy, but how do we get it back to us? We can just use the chat as communication method between the admin and us, of course! The source code shows a function `post(text)` which posts the given text as chat message. So all we need to do is execute `post(getAdminKey())` on the admin's end, and the admin key is ours. To do this, we just need to wrap this code in a `<script>` tag, and post it as chat message:

```
<script>post(getAdminKey())</script>
```

The admin key now gets posted in chat by the admin. Copying it, clicking "Load admin panel", and entering this key will successfully open the admin panel, and give us the flag.

This is an example of a [Cross Site Scripting (XSS) attack](https://owasp.org/www-community/attacks/xss/).
